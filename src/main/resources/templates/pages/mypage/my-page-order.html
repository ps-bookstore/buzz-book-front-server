<div th:fragment="myPageOrdersFragment('myOrders', 'hasNext', 'currentPage')">
  <div class="p-5" th:if="${not #lists.isEmpty(myOrders)}">
    <h1 class="text-xl font-bold pb-4">ì£¼ë¬¸/ë°°ì†¡ëª©ë¡</h1>
    <div th:each="myOrder, myOrderStat : ${myOrders}">
      <div class="order">
        <div th:id="'orderId-' + ${myOrderStat.index}"
             th:myOrderIndex="${myOrderStat.index}">
          <br/>
          ì£¼ë¬¸ ë²ˆí˜¸ : <span th:text="${myOrder.orderStr}"></span><br>
          
          ì´ ê°€ê²© : <span th:text="${myOrder.price}"></span><br>
          ì£¼ì†Œ : <span th:text="${myOrder.address}"></span><br>
          ìƒì„¸ ì£¼ì†Œ : <span th:text="${myOrder.addressDetail}"></span><br>
          ìš°í¸ ë²ˆí˜¸ : <span th:text="${myOrder.zipcode}"></span><br>
          í¬ë§ ë°°ì†¡ì¼ : <span th:text="${myOrder.desiredDeliveryDate}"></span><br>
          ìˆ˜ì‹ ì : <span th:text="${myOrder.receiver}"></span><br>
          ìˆ˜ì‹ ì ì—°ë½ì²˜ : <span th:text="${myOrder.receiverContactNumber}"></span><br>
          ë°œì‹ ì : <span th:text="${myOrder.sender}"></span><br>
          ë°œì‹ ì ì—°ë½ì²˜ : <span th:text="${myOrder.senderContactNumber}"></span><br>
          <div th:if="${not #strings.isEmpty(myOrder.orderEmail)}">
            ì´ë©”ì¼ : <span th:text="${myOrder.orderEmail}"></span><br>
          </div>
          ìš´ì„ë¹„ : <span th:text="${myOrder.deliveryRate}"></span><br>
          
          <div th:if="${not #strings.isEmpty(myOrder.couponCode)}">
            ì¿ í° ì½”ë“œ : <span th:text="${myOrder.couponCode}"></span><br>
          </div>

          ì£¼ë¬¸ ìƒíƒœ : <span th:text="${myOrder.orderStatus}"></span><br>
          <div th:if="${not #strings.isEmpty(myOrder.deductedPoints)}">
            ì‚¬ìš© í¬ì¸íŠ¸ : <span th:text="${myOrder.deductedPoints}"></span><br>
          </div>
          <div th:if="${not #strings.isEmpty(myOrder.earnedPoints)}">
            ì ë¦½ í¬ì¸íŠ¸ : <span th:text="${myOrder.earnedPoints}"></span><br>
          </div>
          <div th:if="${not #strings.isEmpty(myOrder.deductedCouponPrice)}">
            ì‚¬ìš©ëœ ì¿ í° ê¸ˆì•¡ : <span th:text="${myOrder.deductedCouponPrice}"></span><br>
          </div>
          
          <!-- Toggle Button for Details -->
          <button type="button" class="toggle-details-btn"
                  th:id="'toggle-btn-' + ${myOrderStat.index}"
                  th:onclick="'toggleDetails(' +${myOrderStat.index} + ')'">
            ğŸ”½
          </button>
          
          <div class="orderDetail border border-solid border-[#eee]"
               th:id="'orderDetailId-' + 'orderId-'+ ${myOrderStat.index}" style="display: none;">
            <div th:if="${not #lists.isEmpty(myOrder.details)}">
              <div th:each="detail : ${myOrder.details}">
                ìƒí’ˆ ì´ë¦„: <span th:text="${detail.orderDetailProductName}"></span><br>
                ìƒí’ˆ ê°€ê²© : <span id="cancelAmount" th:text="${detail.orderDetailPrice}"></span><br>
                ìƒí’ˆ ìˆ˜ëŸ‰ : <span th:text="${detail.orderDetailQuantity}"></span><br>
                í¬ì¥ ì—¬ë¶€ : <span th:text="${detail.orderDetailWrap}"></span><br>
                ì£¼ë¬¸ì¼ : <span th:text="${detail.orderDetailCreatedAt}"></span><br>
                ì£¼ë¬¸ ìƒíƒœ : <span th:text="${detail.orderDetailOrderStatusName}"></span><br>
                <div th:if="${not #strings.isEmpty(detail.orderDetailWrappingPaper)}">
                  í¬ì¥ì§€ : <span th:text="${detail.orderDetailWrappingPaper}"></span><br>
                </div>
                ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹œê° : <span th:text="${detail.orderDetailUpdatedAt}"></span><br/>
                
                <button type="button"
                        class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                        th:if="${detail.orderDetailOrderStatusName != 'SHIPPING_OUT' and detail.orderDetailOrderStatusName != 'SHIPPED'
                                and detail.orderDetailOrderStatusName != 'PARTIAL_CANCELED'}"
                        th:myOrderDetailId="${detail.orderDetailId}"
                        th:currentPage="${currentPage}"
                        th:onclick="cancelOrderDetailLinkBeforeShipping(this.getAttribute('myOrderDetailId'), this.getAttribute('currentPage'))"
                        th:text="|ë°°ì†¡ ì „ ë¶€ë¶„ ê²°ì œ ì·¨ì†Œ|">
                </button>
                
                <button type="button"
                        class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                        th:if="${detail.orderDetailOrderStatusName != 'SHIPPING_OUT' and detail.orderDetailOrderStatusName != 'SHIPPED'
                                and detail.orderDetailOrderStatusName != 'PARTIAL_CANCELED'}"
                        th:myOrderDetailId="${detail.orderDetailId}"
                        th:currentPage="${currentPage}"
                        th:onclick="refundOrderDetailLink(this.getAttribute('myOrderDetailId'), this.getAttribute('currentPage'))"
                        th:text="|ë¶€ë¶„ ë°˜í’ˆ|">
                </button>
                
                <br/>
              
              </div>
            </div>
          </div>

        </div>
        <label for="cancelReason">ì·¨ì†Œ ì´ìœ :</label>
        <input type="text" id="cancelReason" name="cancelReason">
        <br>
        <button type="button"
                class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                th:myOrder="${myOrder.orderStr}"
                th:currentPage="${currentPage}"
                th:onclick="cancelOrderLinkBeforeShipping(this.getAttribute('myOrder'), this.getAttribute('currentPage'))"
                th:text="|ë°°ì†¡ ì „ ê²°ì œ ì·¨ì†Œ|">
        </button>
        
        <button type="button"
                class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                th:myOrder="${myOrder.orderStr}"
                th:currentPage="${currentPage}"
                th:onclick="refundOrderLink(this.getAttribute('myOrder'), this.getAttribute('currentPage'))"
                th:text="|ë°˜í’ˆ|">
        </button>
        
        <button type="button"
                class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                th:myOrder="${myOrder.orderStr}"
                th:currentPage="${currentPage}"
                th:onclick="breakageRefundOrderLink(this.getAttribute('myOrder'), this.getAttribute('currentPage'))"
                th:text="|íŒŒì†ì— ì˜í•œ ë°˜í’ˆ|">
        </button>
        <br/>
        
        <button type="button" class="btn btn-sm w-20-l bg-[#81c408] hover:bg-[#22a343] text-white"
                th:onclick="|location.href='@{/mybilllogs(orderId=${myOrder.orderStr})}'|">ê²°ì œ ë‚´ì—­
        </button>
      
      </div>
      <div class="divider"></div>
    </div>
  </div>

  <input type="hidden" id="size" name="size" th:value="10"/>
  <a th:href="@{/orders(page=${currentPage-1}, size=10)}">ì´ì „</a>
  <label for="currentPage"></label>
  <input id="currentPage" name="currentPage" th:value="${currentPage}" readonly/>
  <a th:if="${#bools.isTrue(hasNext)}" th:href="@{/admin/orders(page=${currentPage + 1}, size=10)}">ë‹¤ìŒ</a>
  
  <script th:inline="javascript">
      function cancelOrderLinkBeforeShipping(orderId, currentPage) {
          const cancelReasonInput = document.getElementById('cancelReason');
          const cancelReason = cancelReasonInput ? cancelReasonInput.value : '';
          const url = '/myorder/cancel?id=' + orderId +
              '&cancelReason=' + encodeURIComponent(cancelReason) +
              '&page=' + currentPage + '&size=10';

          fetch(url, {method: 'GET'})
              .then(data => {
                  if (data.ok) {
                      alert('Cancel successfully.');
                  } else if (data.status === 500) {
                      alert('ë°°ì†¡ ì „ ê²°ì œ ì™„ë£Œ ê±´ì—ì„œë§Œ ì·¨ì†Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                  }
                  location.href = '/orders?page=' + currentPage + '&size=10';
              })
              .catch(error => {
                  alert('ë°°ì†¡ ì „ ê²°ì œ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
              });
      }

      function refundOrderLink(orderId, currentPage) {
          const url = '/myorder/refund?id=' + orderId +
              '&orderStatus=REFUND' +
              '&page=' + currentPage + '&size=10';
          fetch(url, {method: 'GET'})
              .then(data => {
                  if (data.ok) {
                      alert('Refund successfully.');
                  } else if (data.status === 500) {
                      alert('ë°°ì†¡ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                  }
                  location.href = '/orders?page=' + currentPage + '&size=10';
              })
              .catch(error => {
                  alert('ë°°ì†¡ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
              });
      }

      function breakageRefundOrderLink(orderId, currentPage) {
          const url = '/myorder/refund?id=' + orderId +
              '&orderStatus=BREAKAGE_REFUND' +
              '&page=' + currentPage + '&size=10';

          fetch(url, {method: 'GET'})
              .then(data => {
                  if (data.ok) {
                      alert('Refund successfully.');
                  } else if (data.status === 500) {
                      alert('ë°°ì†¡ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                  }
                  location.href = '/orders?page=' + currentPage + '&size=10';
              })
              .catch(error => {
                  alert('ë°°ì†¡ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
              });
      }

      function cancelOrderDetailLinkBeforeShipping(orderDetailId, currentPage) {
          const cancelReasonInput = document.getElementById('cancelReason');
          const cancelReason = cancelReasonInput ? cancelReasonInput.value : '';
          const url = '/myorderdetail/cancel/toss?id=' + orderDetailId +
              '&cancelReason=' + encodeURIComponent(cancelReason) +
              '&page=' + currentPage + '&size=10';

          fetch(url, {method: 'GET'})
              .then(data => {
                  if (data.ok) {
                      alert('Order detail canceled successfully.');
                  } else if (data.status === 500) {
                      alert('ë°°ì†¡ ì „ ê²°ì œ ì™„ë£Œ ê±´ì—ì„œë§Œ ì·¨ì†Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                  }
                  alert('Error: ' + error.message);
              });
      }

      function refundOrderDetailLink(orderDetailId, currentPage) {
          const cancelReasonInput = document.getElementById('cancelReason');
          const cancelReason = cancelReasonInput ? cancelReasonInput.value : '';
          const url = '/myorderdetail/refund?id=' + orderDetailId +
              '&page=' + currentPage + '&size=10';

          fetch(url, {method: 'GET'})
              .then(data => {
                  if (data.ok) {
                      alert('Order detail refund successfully.');
                  } else if (data.status === 500) {
                      alert('ë°°ì†¡ ì „ ê²°ì œ ì™„ë£Œ ê±´ì—ì„œë§Œ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                  }
              })
              .catch(error => {
                  alert('Error: ' + error.message);
              });
      }

      function toggleDetails(orderIdIndex) {
          const details = document.getElementById('orderDetailId-orderId-' + orderIdIndex);
          const toggleBtn = document.getElementById('toggle-btn-' + orderIdIndex);
          if (details.style.display === "none") {
              details.style.display = "block";
              toggleBtn.textContent = "â–¶ï¸";
          } else {
              details.style.display = "none";
              toggleBtn.textContent = "ğŸ”½";
          }
      }
  
  </script>
</div>
